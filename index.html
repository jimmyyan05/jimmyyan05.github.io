<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>我的翻頁電子書（48頁＋縮放）</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />

    <!-- jQuery（必須先於 turn.js） -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- turn.js CDN；失敗則載本機 -->
    <script>
      (function () {
        const s = document.createElement("script");
        s.src =
          "https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js";
        s.onerror = function () {
          const f = document.createElement("script");
          f.src = "lib/turn.min.js";
          document.head.appendChild(f);
        };
        document.head.appendChild(s);
      })();
    </script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #fbf3ea; /* 外框背景 */
        overflow: hidden;
        font-family: system-ui, "PingFang TC", "Microsoft JhengHei", sans-serif;
      }

      /* 置中舞台：用 flex，不與 turn.js 衝突 */
      .viewport {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
      }

      /* 縮放容器：所有縮放/平移都套在這層 */
      .zoom-canvas {
        will-change: transform;
        transform-origin: center center;
      }

      /* 書本本體 */
      #book {
        width: 1060px; /* 530×2 */
        height: 840px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        background: #fbf3ea; /* 書本底色 */
      }

      #book .page {
        width: 530px;
        height: 840px;
        background: #fbf3ea no-repeat center center / 100% 100%;
      }

      /* 載入提示 */
      #msg {
        /* position: fixed;
        left: 50%;
        top: 12px;
        transform: translateX(-50%);
        background: #222;
   
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        display: none;
        z-index: 20;
        opacity: 0.9; */
        color: #fbf3ea;
      }
    </style>
  </head>

  <body>
    <div id="msg">尚未載入 turn.js（僅顯示圖片）</div>

    <div class="viewport" id="viewport">
      <!-- 縮放畫布：縮放與平移都套在這層 -->
      <div class="zoom-canvas" id="zoomCanvas">
        <div id="book">
          <!-- 48頁 -->
          <div class="page" style="background-image: url('pages/1.jpeg')"></div>
          <div class="page" style="background-image: url('pages/2.jpeg')"></div>
          <div class="page" style="background-image: url('pages/3.jpeg')"></div>
          <div class="page" style="background-image: url('pages/4.jpeg')"></div>
          <div class="page" style="background-image: url('pages/5.jpeg')"></div>
          <div class="page" style="background-image: url('pages/6.jpeg')"></div>
          <div class="page" style="background-image: url('pages/7.jpeg')"></div>
          <div class="page" style="background-image: url('pages/8.jpeg')"></div>
          <div class="page" style="background-image: url('pages/9.jpeg')"></div>
          <div
            class="page"
            style="background-image: url('pages/10.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/11.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/12.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/13.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/14.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/15.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/16.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/17.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/18.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/19.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/20.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/21.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/22.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/23.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/24.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/25.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/26.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/27.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/28.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/29.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/30.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/31.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/32.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/33.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/34.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/35.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/36.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/37.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/38.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/39.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/40.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/41.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/42.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/43.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/44.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/45.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/46.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/47.jpeg')"
          ></div>
          <div
            class="page"
            style="background-image: url('pages/48.jpeg')"
          ></div>
        </div>
      </div>
    </div>

    <script>
      function initWhenReady() {
        if (typeof jQuery === "undefined" || !jQuery.fn)
          return setTimeout(initWhenReady, 50);
        if (typeof jQuery.fn.turn !== "function") {
          document.getElementById("msg").style.display = "block";
          return setTimeout(initWhenReady, 100);
        }
        document.getElementById("msg").style.display = "none";

        const $book = $("#book");
        const viewport = document.getElementById("viewport");
        const canvas = document.getElementById("zoomCanvas");

        // 初始化翻頁（交給 CSS 置中，所以關掉 autoCenter）
        $book.turn({
          width: 1060,
          height: 840,
          elevation: 50,
          gradients: true,
          autoCenter: false,
        });

        // === 縮放/平移引擎（rAF 平滑 + GPU 加速 + 游標中心縮放）===
        const BASE_W = 1060,
          BASE_H = 840;
        let baseScale = 1; // 視窗自適應倍率
        let scale = 1; // 使用者縮放倍率（MIN..MAX）
        let tx = 0,
          ty = 0; // 平移（視窗中心為原點）
        const MAX_ZOOM = 16,
          MIN_ZOOM = 1;

        // GPU 加速提示
        canvas.style.willChange = "transform";

        function computeBaseScale() {
          baseScale = Math.min(
            viewport.clientWidth / BASE_W,
            viewport.clientHeight / BASE_H,
            1
          );
        }

        function clampPan() {
          const vw = viewport.clientWidth;
          const vh = viewport.clientHeight;
          const cw = BASE_W * baseScale * scale;
          const ch = BASE_H * baseScale * scale;
          const maxX = Math.max(0, (cw - vw) / 2);
          const maxY = Math.max(0, (ch - vh) / 2);
          if (Math.abs(tx) > maxX) tx = tx < 0 ? -maxX : maxX;
          if (Math.abs(ty) > maxY) ty = ty < 0 ? -maxY : maxY;
          if (cw <= vw) tx = 0;
          if (ch <= vh) ty = 0;
        }

        let rafId = 0;
        function applyTransform() {
          rafId = 0;
          clampPan();
          const s = baseScale * scale;
          canvas.style.transform = `translate3d(${tx}px, ${ty}px, 0) scale(${s})`;
          canvas.classList.toggle("zoomed", scale > 1.001);
        }
        function schedule() {
          if (!rafId) rafId = requestAnimationFrame(applyTransform);
        }

        // 初始化
        function onResize() {
          computeBaseScale();
          schedule();
        }
        window.addEventListener("resize", onResize, { passive: true });
        computeBaseScale();
        schedule();

        // 雙擊：1x / 2x 切換（以點擊位置為中心）
        viewport.addEventListener("dblclick", function (e) {
          const rect = viewport.getBoundingClientRect();
          const cx = e.clientX - rect.left - rect.width / 2;
          const cy = e.clientY - rect.top - rect.height / 2;
          const target = scale > 1.01 ? 1 : 2;
          const sOld = scale,
            sNew = target;

          const contentX = (cx - tx) / (baseScale * sOld);
          const contentY = (cy - ty) / (baseScale * sOld);

          scale = sNew;
          tx = cx - contentX * (baseScale * sNew);
          ty = cy - contentY * (baseScale * sNew);
          schedule();
        });

        // 拖曳平移（放大狀態才啟動）
        let dragging = false,
          sx = 0,
          sy = 0,
          ox = 0,
          oy = 0;
        viewport.addEventListener("pointerdown", (e) => {
          if (scale <= 1.01) return;
          dragging = true;
          sx = e.clientX;
          sy = e.clientY;
          ox = tx;
          oy = ty;
          viewport.setPointerCapture(e.pointerId);
        });
        viewport.addEventListener("pointermove", (e) => {
          if (!dragging) return;
          tx = ox + (e.clientX - sx);
          ty = oy + (e.clientY - sy);
          schedule();
        });
        function endDrag(e) {
          if (!dragging) return;
          dragging = false;
          try {
            viewport.releasePointerCapture(e.pointerId);
          } catch (_) {}
        }
        viewport.addEventListener("pointerup", endDrag);
        viewport.addEventListener("pointercancel", () => (dragging = false));

        // 若仍存在舊的 zoom 按鈕，容錯處理（大多已移除）
        function zoomBy(f) {
          const sOld = scale,
            sNew = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, sOld * f));
          const rect = viewport.getBoundingClientRect();
          const cx = 0,
            cy = 0; // 以中心
          const contentX = (cx - tx) / (baseScale * sOld);
          const contentY = (cy - ty) / (baseScale * sOld);
          scale = sNew;
          tx = cx - contentX * (baseScale * sNew);
          ty = cy - contentY * (baseScale * sNew);
          schedule();
        }
        ["zoomIn", "zoomOut", "zoomReset"].forEach((id, idx) => {
          const el = document.getElementById(id);
          if (!el) return;
          if (idx === 0) el.onclick = () => zoomBy(1.2);
          if (idx === 1) el.onclick = () => zoomBy(1 / 1.2);
          if (idx === 2)
            el.onclick = () => {
              scale = 1;
              tx = 0;
              ty = 0;
              schedule();
            };
        });
        // 翻頁控制
        document.addEventListener("keydown", (e) => {
          if (e.key === "ArrowLeft") $book.turn("previous");
          if (e.key === "ArrowRight") $book.turn("next");
        });

        $book.on("click", ".page", function (e) {
          const pageWidth = $(this).width();
          const clickX = e.offsetX;
          if (clickX < pageWidth / 2) {
            $book.turn("previous");
          } else {
            $book.turn("next");
          }
        });
      }
      initWhenReady();
    </script>
  </body>
</html>
